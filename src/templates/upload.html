{% extends "base.html" %}

{% block title %}Upload Data - Spotify Data Tool{% endblock %}

{% block content %}
<div class="max-w-xl mx-auto mt-12">
    <div class="text-center mb-8">
        <svg class="w-16 h-16 text-spotify-green mx-auto mb-4" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/>
        </svg>
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Upload Your Spotify Data</h1>
        <p class="text-gray-600">Download your data from <a href="https://www.spotify.com/account/privacy/" class="text-spotify-green hover:underline" target="_blank" rel="noopener">Spotify privacy settings</a>, then upload the zip file here.</p>
    </div>

    <!-- Error display -->
    <div id="upload-error" class="hidden bg-red-50 border border-red-300 text-red-700 rounded-lg p-4 mb-6">
        <p id="upload-error-text"></p>
    </div>

    <!-- Upload form -->
    <form id="upload-form" class="bg-white rounded-lg shadow-md p-8">
        <!-- Drop zone -->
        <div id="drop-zone"
             class="border-2 border-dashed border-gray-300 rounded-lg p-10 text-center cursor-pointer
                    transition-colors duration-200 hover:border-spotify-green">
            <!-- Default state -->
            <div id="drop-zone-prompt">
                <svg class="w-12 h-12 text-gray-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                </svg>
                <p class="text-gray-600 font-medium mb-1">Drag and drop your zip file here</p>
                <p class="text-gray-400 text-sm">or <span class="text-spotify-green font-semibold">browse</span> to choose a file</p>
                <p class="mt-3 text-xs text-gray-400">Accepts .zip files up to 50 MB</p>
            </div>
            <!-- File selected state -->
            <div id="drop-zone-selected" class="hidden">
                <svg class="w-12 h-12 text-spotify-green mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <p id="selected-filename" class="text-gray-800 font-medium mb-1"></p>
                <p id="selected-filesize" class="text-gray-400 text-sm"></p>
                <p class="mt-2 text-xs text-gray-400">Click or drop again to change file</p>
            </div>
        </div>

        <input id="file-input" name="file" type="file" accept=".zip" required class="hidden" />

        <button
            id="upload-btn"
            type="submit"
            disabled
            class="mt-6 w-full bg-spotify-green hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
        >
            Upload and Explore
        </button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
(function () {
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const form = document.getElementById('upload-form');
    const btn = document.getElementById('upload-btn');
    const errorBox = document.getElementById('upload-error');
    const errorText = document.getElementById('upload-error-text');
    const prompt = document.getElementById('drop-zone-prompt');
    const selected = document.getElementById('drop-zone-selected');
    const selectedName = document.getElementById('selected-filename');
    const selectedSize = document.getElementById('selected-filesize');

    function formatSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function showSelected(file) {
        selectedName.textContent = file.name;
        selectedSize.textContent = formatSize(file.size);
        prompt.classList.add('hidden');
        selected.classList.remove('hidden');
        btn.disabled = false;
        dropZone.classList.remove('border-gray-300');
        dropZone.classList.add('border-spotify-green');
    }

    // Click the drop zone to open file picker
    dropZone.addEventListener('click', () => fileInput.click());

    // File chosen via picker
    fileInput.addEventListener('change', () => {
        if (fileInput.files.length) showSelected(fileInput.files[0]);
    });

    // Drag events
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('border-spotify-green', 'bg-green-50');
    });

    dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.classList.remove('bg-green-50');
        if (!fileInput.files.length) {
            dropZone.classList.remove('border-spotify-green');
        }
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('bg-green-50');

        const file = e.dataTransfer.files[0];
        if (!file) return;

        // Transfer the dropped file to the hidden input
        const dt = new DataTransfer();
        dt.items.add(file);
        fileInput.files = dt.files;

        showSelected(file);
    });

    // Prevent default browser behaviour for drag on the whole page
    document.addEventListener('dragover', (e) => e.preventDefault());
    document.addEventListener('drop', (e) => e.preventDefault());

    // Form submission
    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        errorBox.classList.add('hidden');
        if (!fileInput.files.length) return;

        btn.disabled = true;
        btn.textContent = 'Uploading...';

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        try {
            const resp = await fetch('/api/upload', {
                method: 'POST',
                body: formData,
                redirect: 'follow',
            });

            if (resp.redirected) {
                window.location.href = resp.url;
                return;
            }

            if (!resp.ok) {
                const data = await resp.json();
                errorText.textContent = data.error || 'Upload failed.';
                errorBox.classList.remove('hidden');
            }
        } catch (err) {
            errorText.textContent = 'Network error. Please try again.';
            errorBox.classList.remove('hidden');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Upload and Explore';
        }
    });
})();
</script>
{% endblock %}
