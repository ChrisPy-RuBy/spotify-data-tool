{% extends "base.html" %}

{% block title %}Analytics - Spotify Data Tool{% endblock %}

{% block content %}
<div x-data="analyticsData()">
    <!-- Page Header -->
    <div class="mb-8 flex justify-between items-start">
        <div>
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Analytics Dashboard</h1>
            <p class="text-gray-600">Explore your listening habits and discover insights</p>
        </div>
        <!-- Export Buttons -->
        <div class="flex space-x-2">
            <button
                @click="exportAllToCSV()"
                class="px-4 py-2 bg-spotify-green text-white rounded-lg hover:bg-green-600 transition-colors duration-200 flex items-center space-x-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <span>Export CSV</span>
            </button>
            <button
                @click="exportAllToJSON()"
                class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors duration-200 flex items-center space-x-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <span>Export JSON</span>
            </button>
        </div>
    </div>

    <!-- Overview Stats -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"
         hx-get="/api/analytics/overview"
         hx-trigger="load"
         hx-swap="innerHTML">
        <!-- Loading state -->
        <div class="bg-white rounded-lg shadow-md p-6 animate-pulse">
            <div class="h-4 bg-gray-200 rounded w-1/2 mb-4"></div>
            <div class="h-8 bg-gray-200 rounded w-3/4"></div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="space-y-8">
        <!-- Most Common Tracks by Playlist -->
        <div class="bg-white shadow-md rounded-lg p-6">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-2xl font-semibold text-gray-800">Most Common Tracks</h2>
                    <span class="text-sm text-gray-500">By playlist appearance</span>
                </div>
                <!-- Chart Type Toggle -->
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-gray-500">Chart:</span>
                    <div class="flex rounded-lg overflow-hidden border border-gray-300">
                        <button @click="toggleChartType('playlist', 'bar')"
                                :class="playlistChartType === 'bar' ? 'bg-spotify-green text-white' : 'bg-white text-gray-700 hover:bg-gray-100'"
                                class="px-3 py-1 text-sm transition-colors">Bar</button>
                        <button @click="toggleChartType('playlist', 'pie')"
                                :class="playlistChartType === 'pie' ? 'bg-spotify-green text-white' : 'bg-white text-gray-700 hover:bg-gray-100'"
                                class="px-3 py-1 text-sm transition-colors border-l border-gray-300">Pie</button>
                        <button @click="toggleChartType('playlist', 'doughnut')"
                                :class="playlistChartType === 'doughnut' ? 'bg-spotify-green text-white' : 'bg-white text-gray-700 hover:bg-gray-100'"
                                class="px-3 py-1 text-sm transition-colors border-l border-gray-300">Doughnut</button>
                    </div>
                </div>
            </div>
            <div class="mb-6">
                <canvas id="playlist-chart" class="w-full" style="max-height: 600px;"></canvas>
            </div>
        </div>

        <!-- Most Played Tracks -->
        <div class="bg-white shadow-md rounded-lg p-6">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-2xl font-semibold text-gray-800">Most Played Tracks</h2>
                    <span class="text-sm text-gray-500">From streaming history</span>
                </div>
                <!-- Chart Type Toggle -->
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-gray-500">Chart:</span>
                    <div class="flex rounded-lg overflow-hidden border border-gray-300">
                        <button @click="toggleChartType('plays', 'bar')"
                                :class="playsChartType === 'bar' ? 'bg-blue-500 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'"
                                class="px-3 py-1 text-sm transition-colors">Bar</button>
                        <button @click="toggleChartType('plays', 'pie')"
                                :class="playsChartType === 'pie' ? 'bg-blue-500 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'"
                                class="px-3 py-1 text-sm transition-colors border-l border-gray-300">Pie</button>
                        <button @click="toggleChartType('plays', 'doughnut')"
                                :class="playsChartType === 'doughnut' ? 'bg-blue-500 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'"
                                class="px-3 py-1 text-sm transition-colors border-l border-gray-300">Doughnut</button>
                    </div>
                </div>
            </div>
            <div class="mb-6">
                <canvas id="plays-chart" class="w-full" style="max-height: 600px;"></canvas>
            </div>
        </div>

        <!-- Top Artists -->
        <div class="bg-white shadow-md rounded-lg p-6">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-2xl font-semibold text-gray-800">Top Artists</h2>
                    <span class="text-sm text-gray-500">By play count</span>
                </div>
                <!-- Chart Type Toggle -->
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-gray-500">Chart:</span>
                    <div class="flex rounded-lg overflow-hidden border border-gray-300">
                        <button @click="toggleChartType('artists', 'bar')"
                                :class="artistsChartType === 'bar' ? 'bg-purple-500 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'"
                                class="px-3 py-1 text-sm transition-colors">Bar</button>
                        <button @click="toggleChartType('artists', 'pie')"
                                :class="artistsChartType === 'pie' ? 'bg-purple-500 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'"
                                class="px-3 py-1 text-sm transition-colors border-l border-gray-300">Pie</button>
                        <button @click="toggleChartType('artists', 'doughnut')"
                                :class="artistsChartType === 'doughnut' ? 'bg-purple-500 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'"
                                class="px-3 py-1 text-sm transition-colors border-l border-gray-300">Doughnut</button>
                    </div>
                </div>
            </div>
            <div class="mb-6">
                <canvas id="artists-chart" class="w-full" style="max-height: 600px;"></canvas>
            </div>
        </div>

        <!-- Listening Time Stats -->
        <div class="bg-white shadow-md rounded-lg p-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Listening Time Statistics</h2>
            <div hx-get="/api/analytics/listening-time-stats"
                 hx-trigger="load"
                 hx-swap="innerHTML">
                <div class="animate-pulse grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="h-20 bg-gray-200 rounded"></div>
                    <div class="h-20 bg-gray-200 rounded"></div>
                    <div class="h-20 bg-gray-200 rounded"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function analyticsData() {
    return {
        playlistChart: null,
        playsChart: null,
        artistsChart: null,
        playlistChartType: 'bar',
        playsChartType: 'bar',
        artistsChartType: 'bar',
        playlistData: [],
        playsData: [],
        artistsData: [],

        init() {
            this.loadAllCharts();

            // Listen for stats loading
            document.body.addEventListener('htmx:afterSwap', (event) => {
                if (event.detail.target.getAttribute('hx-get') === '/api/analytics/overview') {
                    this.renderStatsCards(event.detail.xhr.response);
                } else if (event.detail.target.getAttribute('hx-get') === '/api/analytics/listening-time-stats') {
                    this.renderTimeStats(event.detail.xhr.response, event.detail.target);
                }
            });
        },

        async loadAllCharts() {
            await Promise.all([
                this.loadPlaylistChart(),
                this.loadPlaysChart(),
                this.loadArtistsChart()
            ]);
        },

        generateColors(count) {
            const colors = [
                'rgba(29, 185, 84, 0.7)',
                'rgba(59, 130, 246, 0.7)',
                'rgba(168, 85, 247, 0.7)',
                'rgba(249, 115, 22, 0.7)',
                'rgba(236, 72, 153, 0.7)',
                'rgba(34, 197, 94, 0.7)',
                'rgba(99, 102, 241, 0.7)',
                'rgba(245, 158, 11, 0.7)',
                'rgba(14, 165, 233, 0.7)',
                'rgba(239, 68, 68, 0.7)',
                'rgba(132, 204, 22, 0.7)',
                'rgba(217, 70, 239, 0.7)',
                'rgba(20, 184, 166, 0.7)',
                'rgba(251, 146, 60, 0.7)',
                'rgba(129, 140, 248, 0.7)',
                'rgba(52, 211, 153, 0.7)',
                'rgba(244, 114, 182, 0.7)',
                'rgba(96, 165, 250, 0.7)',
                'rgba(163, 230, 53, 0.7)',
                'rgba(251, 191, 36, 0.7)',
            ];
            return colors.slice(0, count);
        },

        toggleChartType(chart, type) {
            if (chart === 'playlist') {
                this.playlistChartType = type;
                this.updateChart('playlist', this.playlistData, type);
            } else if (chart === 'plays') {
                this.playsChartType = type;
                this.updateChart('plays', this.playsData, type);
            } else if (chart === 'artists') {
                this.artistsChartType = type;
                this.updateChart('artists', this.artistsData, type);
            }
        },

        updateChart(chartName, data, type) {
            let chart, canvasId, labelKey, valueKey, baseColor;

            if (chartName === 'playlist') {
                chart = this.playlistChart;
                canvasId = 'playlist-chart';
                labelKey = d => `${d.track_name} - ${d.artist_name}`;
                valueKey = 'playlist_count';
                baseColor = 'rgba(29, 185, 84, 0.6)';
            } else if (chartName === 'plays') {
                chart = this.playsChart;
                canvasId = 'plays-chart';
                labelKey = d => `${d.track_name} - ${d.artist_name}`;
                valueKey = 'play_count';
                baseColor = 'rgba(59, 130, 246, 0.6)';
            } else {
                chart = this.artistsChart;
                canvasId = 'artists-chart';
                labelKey = d => d.artist_name;
                valueKey = 'play_count';
                baseColor = 'rgba(168, 85, 247, 0.6)';
            }

            // Destroy existing chart
            if (chart) chart.destroy();

            const ctx = document.getElementById(canvasId).getContext('2d');
            const isPie = type === 'pie' || type === 'doughnut';
            const colors = isPie ? this.generateColors(data.length) : baseColor;

            const newChart = new Chart(ctx, {
                type: type,
                data: {
                    labels: data.map(labelKey),
                    datasets: [{
                        label: valueKey === 'playlist_count' ? 'Playlist Count' : 'Play Count',
                        data: data.map(d => d[valueKey]),
                        backgroundColor: colors,
                        borderColor: isPie ? 'white' : baseColor.replace('0.6', '1'),
                        borderWidth: isPie ? 2 : 1
                    }]
                },
                options: {
                    indexAxis: type === 'bar' ? 'y' : undefined,
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: isPie, position: 'right' }
                    },
                    scales: isPie ? {} : {
                        x: { beginAtZero: true, ticks: { precision: 0 } }
                    }
                }
            });

            if (chartName === 'playlist') this.playlistChart = newChart;
            else if (chartName === 'plays') this.playsChart = newChart;
            else this.artistsChart = newChart;
        },

        async loadPlaylistChart() {
            const response = await fetch('/api/analytics/top-tracks-by-playlist?limit=20');
            this.playlistData = await response.json();

            const ctx = document.getElementById('playlist-chart').getContext('2d');
            this.playlistChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: this.playlistData.map(d => `${d.track_name} - ${d.artist_name}`),
                    datasets: [{
                        label: 'Playlist Count',
                        data: this.playlistData.map(d => d.playlist_count),
                        backgroundColor: 'rgba(29, 185, 84, 0.6)',
                        borderColor: 'rgba(29, 185, 84, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        },

        async loadPlaysChart() {
            const response = await fetch('/api/analytics/top-tracks-by-plays?limit=20');
            this.playsData = await response.json();

            const ctx = document.getElementById('plays-chart').getContext('2d');
            this.playsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: this.playsData.map(d => `${d.track_name} - ${d.artist_name}`),
                    datasets: [{
                        label: 'Play Count',
                        data: this.playsData.map(d => d.play_count),
                        backgroundColor: 'rgba(59, 130, 246, 0.6)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        },

        async loadArtistsChart() {
            const response = await fetch('/api/analytics/top-artists?limit=15');
            this.artistsData = await response.json();

            const ctx = document.getElementById('artists-chart').getContext('2d');
            this.artistsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: this.artistsData.map(d => d.artist_name),
                    datasets: [{
                        label: 'Play Count',
                        data: this.artistsData.map(d => d.play_count),
                        backgroundColor: 'rgba(168, 85, 247, 0.6)',
                        borderColor: 'rgba(168, 85, 247, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        },

        renderStatsCards(responseText) {
            const data = JSON.parse(responseText);
            const target = document.querySelector('[hx-get="/api/analytics/overview"]');

            target.innerHTML = `
                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-spotify-green">
                    <div class="text-gray-500 text-sm font-medium mb-1">Total Playlists</div>
                    <div class="text-3xl font-bold text-gray-800">${data.playlists.total.toLocaleString()}</div>
                    <div class="text-gray-500 text-xs mt-2">${data.playlists.total_tracks.toLocaleString()} total tracks</div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-blue-500">
                    <div class="text-gray-500 text-sm font-medium mb-1">Unique Tracks</div>
                    <div class="text-3xl font-bold text-gray-800">${data.playlists.unique_tracks.toLocaleString()}</div>
                    <div class="text-gray-500 text-xs mt-2">Avg ${data.playlists.avg_items_per_playlist.toFixed(1)} per playlist</div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-purple-500">
                    <div class="text-gray-500 text-sm font-medium mb-1">Total Plays</div>
                    <div class="text-3xl font-bold text-gray-800">${data.streaming.total_plays.toLocaleString()}</div>
                    <div class="text-gray-500 text-xs mt-2">${data.streaming.avg_minutes_per_play.toFixed(1)} min avg</div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-orange-500">
                    <div class="text-gray-500 text-sm font-medium mb-1">Listening Time</div>
                    <div class="text-3xl font-bold text-gray-800">${data.streaming.total_hours.toFixed(1)}h</div>
                    <div class="text-gray-500 text-xs mt-2">${data.streaming.total_days.toFixed(1)} days</div>
                </div>
            `;
        },

        renderTimeStats(responseText, target) {
            const data = JSON.parse(responseText);

            target.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-gradient-to-br from-spotify-green to-green-600 text-white rounded-lg p-6">
                        <div class="text-sm opacity-90 mb-2">Total Listening Time</div>
                        <div class="text-4xl font-bold">${data.total_hours.toFixed(1)}</div>
                        <div class="text-sm opacity-75 mt-1">hours (${data.total_days.toFixed(2)} days)</div>
                    </div>
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-lg p-6">
                        <div class="text-sm opacity-90 mb-2">Total Plays</div>
                        <div class="text-4xl font-bold">${data.total_plays.toLocaleString()}</div>
                        <div class="text-sm opacity-75 mt-1">streaming events</div>
                    </div>
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-lg p-6">
                        <div class="text-sm opacity-90 mb-2">Avg Play Duration</div>
                        <div class="text-4xl font-bold">${data.avg_minutes_per_play.toFixed(1)}</div>
                        <div class="text-sm opacity-75 mt-1">minutes per play</div>
                    </div>
                </div>
            `;
        },

        exportAllToCSV() {
            // Export top tracks by playlist
            let csv = 'MOST COMMON TRACKS BY PLAYLIST\n';
            csv += 'Track Name,Artist,Playlist Count\n';
            this.playlistData.forEach(d => {
                csv += `"${(d.track_name || '').replace(/"/g, '""')}","${(d.artist_name || '').replace(/"/g, '""')}",${d.playlist_count}\n`;
            });

            // Export most played tracks
            csv += '\nMOST PLAYED TRACKS\n';
            csv += 'Track Name,Artist,Play Count\n';
            this.playsData.forEach(d => {
                csv += `"${(d.track_name || '').replace(/"/g, '""')}","${(d.artist_name || '').replace(/"/g, '""')}",${d.play_count}\n`;
            });

            // Export top artists
            csv += '\nTOP ARTISTS\n';
            csv += 'Artist Name,Play Count\n';
            this.artistsData.forEach(d => {
                csv += `"${(d.artist_name || '').replace(/"/g, '""')}",${d.play_count}\n`;
            });

            this.downloadFile(csv, 'analytics-export.csv', 'text/csv');
        },

        exportAllToJSON() {
            const data = {
                exported_at: new Date().toISOString(),
                most_common_tracks_by_playlist: this.playlistData,
                most_played_tracks: this.playsData,
                top_artists: this.artistsData
            };

            const json = JSON.stringify(data, null, 2);
            this.downloadFile(json, 'analytics-export.json', 'application/json');
        },

        downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    }
}
</script>
{% endblock %}
